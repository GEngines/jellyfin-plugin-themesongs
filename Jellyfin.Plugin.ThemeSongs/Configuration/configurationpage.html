<!DOCTYPE html>
<html>

<head>
    <title>Advanced Theme Songs</title>
</head>

<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage tbsConfigurationPage"
        data-require="emby-input,emby-button">
        <div data-role="content">
            <div class="content-primary">
                <form class="tbsConfigurationPage" id="ThemeSongsConfigForm">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Theme Songs</h2>
                        <a is="emby-linkbutton" class="raised button-alt headerHelpButton emby-button" target="_blank"
                            href="https://github.com/GEngines/jellyfin-plugin-themesongs">Help</a>
                    </div>
                    <div class="verticalSection">
                        <p>This plugin relies on the TVDB provider
                            Please make sure it is enabled!</p>
                        <br />
                    </div>
                    
                    <br />
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="customThemeSongsPath">Custom Theme Songs Path
                        </label>
                        <input is="emby-input" type="text" id="customThemeSongsPath" name="customThemeSongsPath"
                            class="emby-input" />
                        <div class="fieldDescription">
                            Central location for all theme songs. Use patterns like {SeriesName} or {SeriesId} in filenames.
                        </div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input type="checkbox" is="emby-checkbox" id="useCustomPathExclusively"
                                name="useCustomPathExclusively" />
                            <span>Use custom path exclusively</span>
                        </label>
                        <div class="fieldDescription checkboxFieldDescription">
                            If checked, only look for theme songs in the custom path. Otherwise, fallback to series folders.
                        </div>
                    </div>
                    
                    <br />
                    <div class="sliderContainer">
                        <label for="themeVolume" class="sliderLabel">Theme Song Volume</label>
                        <input is="emby-slider" type="range" id="themeVolume" name="themeVolume" 
                               min="0" max="100" step="5" class="emby-slider" />
                        <div class="fieldDescription">
                            Set the default playback volume for theme songs (20% recommended).
                        </div>
                    </div>

                    <script>
                        var ThemeSongsConfig = {
                            pluginId: "afe1de9c-63e4-4692-8d8c-7c964df19eb2"
                        };

                        function loadPage() {
                            Dashboard.showLoadingMsg();
                            
                            ApiClient.getPluginConfiguration(ThemeSongsConfig.pluginId).then(function (config) {
                                document.querySelector('#customThemeSongsPath').value = config.CustomThemeSongsPath || '';
                                document.querySelector('#useCustomPathExclusively').checked = config.UseCustomPathExclusively || false;
                                document.querySelector('#themeVolume').value = config.ThemeVolume || 20;
                                
                                Dashboard.hideLoadingMsg();
                            });
                        }

                        $('#ThemeSongsConfigForm').on('submit', function(e) {
                            Dashboard.showLoadingMsg();
                            
                            // Get the current configuration
                            ApiClient.getPluginConfiguration(ThemeSongsConfig.pluginId).then(function (config) {
                                // Update with new values
                                config.CustomThemeSongsPath = document.querySelector('#customThemeSongsPath').value;
                                config.UseCustomPathExclusively = document.querySelector('#useCustomPathExclusively').checked;
                                config.ThemeVolume = parseInt(document.querySelector('#themeVolume').value) || 20;
                                
                                // Save the configuration
                                ApiClient.updatePluginConfiguration(ThemeSongsConfig.pluginId, config).then(function () {
                                    Dashboard.processPluginConfigurationUpdateResult();
                                });
                            });
                            
                            e.preventDefault();
                            return false;
                        });

                        // Load the page when DOM is ready
                        $(document).ready(function() {
                            loadPage();
                        });
                    </script>
                    <br />
                    <div style="display: flex; gap: 10px;">
                        <button is="emby-button" type="submit" class="raised button-submit emby-button">
                            <span>Save Settings</span>
                        </button>
                        <button is="emby-button" type="button" class="raised block" id="refresh-library"
                            onclick=download()><span>Download Theme Songs</span></button>
                    </div>
                </form>
            </div>
        </div>

        <div class="fieldDescription" style="margin-top: 1em;">
            Theme Songs Plugin v1.1.2.0 - Custom Paths Edition
        </div>

        <script type="text/javascript">
            function download() {
                var request = {
                    url: ApiClient.getUrl('/ThemeSongs/DownloadTVShows'),
                    type: 'POST'
                };

                ApiClient.fetch(request).then(function () {
                    Dashboard.alert("Downloading Theme Songs...");
                }).catch(function () {
                    Dashboard.alert({
                        message: "Unexpected error occurred!"
                    });
                });
            }
            
            // Add script to the main Jellyfin UI to control theme volume
            function injectVolumeControlScript() {
                // Don't inject multiple times
                if (window.themeSongsVolumeInjected) return;
                window.themeSongsVolumeInjected = true;
                
                // Get the volume setting from config
                ApiClient.getPluginConfiguration('afe1de9c-63e4-4692-8d8c-7c964df19eb2').then(function (config) {
                    // Create volume control script
                    var script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = ApiClient.getUrl('/ThemeSongs/VolumeControl.js');
                    document.head.appendChild(script);
                    console.log('Theme Songs volume control script injected');
                });
            }
            
            // Run once when loading the admin page
            injectVolumeControlScript();
            
            // Also inject when navigating back to the main UI
            document.addEventListener('viewshow', function(e) {
                setTimeout(injectVolumeControlScript, 1000);
            });
        </script>
    </div>
</body>

</html>